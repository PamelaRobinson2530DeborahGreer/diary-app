# ☁️ 云同步功能说明

## 📋 功能概述

加密日记应用现已支持云同步功能！您可以在多个设备间安全地同步您的日记数据。

### 核心特性

✅ **端到端加密** - 服务器永远无法解密您的数据
✅ **零知识架构** - 加密密钥永不离开您的设备
✅ **多设备同步** - 支持手机、平板、电脑同步
✅ **自动同步** - 可配置自动同步间隔
✅ **冲突检测** - 智能处理多设备编辑冲突

---

## 🔐 安全架构

### 三层加密保护

```
用户PIN码 → 主密钥 → 日记内容加密
      ↓
同步密码 → 同步密钥 → 主密钥加密（上传云端）
      ↓
HTTPS → 传输加密
```

### 服务器存储内容

服务器**仅存储**以下内容：
- ✅ 加密的主密钥（用同步密码加密）
- ✅ 加密的日记内容
- ✅ 元数据（心情标签、创建时间等）
- ❌ **不存储**解密密钥
- ❌ **不存储**PIN码
- ❌ **不存储**同步密码

---

## 🚀 如何使用

### 第一次设置（主设备）

1. **启用PIN加密**
   - 进入"设置"页面
   - 开启"加密保护"
   - 设置6位PIN码

2. **设置云同步**
   - 在"设置"中找到"云同步"选项
   - 点击"启用云同步"
   - 设置同步密码（建议与PIN不同，增强安全性）
   - 点击"开始同步"

3. **首次上传**
   - 系统会自动上传您现有的所有日记
   - 等待上传完成

### 新设备接入

1. **安装应用**
   - 在新设备上打开日记应用

2. **登录云同步**
   - 进入"设置" → "云同步"
   - 点击"登录到云同步"
   - 输入您的同步密码
   - 等待下载完成

3. **设置PIN**
   - 下载完成后，系统会要求设置PIN
   - 可以使用与主设备相同的PIN，也可以使用不同的PIN

---

## ⚙️ 同步设置

### 自动同步

- **开启自动同步**: 设置 → 云同步 → 自动同步
- **同步间隔**: 可选 5/10/15/30 分钟
- **手动同步**: 点击"立即同步"按钮

### 查看同步状态

设置页面会显示：
- 最后同步时间
- 当前设备数量
- 同步历史记录

---

## 🔄 同步工作原理

### 增量同步

系统采用智能增量同步：
1. 只同步变更的日记
2. 使用向量时钟检测冲突
3. 避免重复上传已同步内容

### 冲突解决

当检测到冲突时：
1. **自动解决**: 最后修改时间晚的版本胜出
2. **手动解决**: 您可以选择保留哪个版本
3. **合并选项**: 可以合并两个版本

---

## 📱 设备管理

### 查看设备列表

设置 → 云同步 → 管理设备

可以看到：
- 设备名称
- 最后同步时间
- 设备类型

### 删除设备

1. 进入设备管理
2. 选择要删除的设备
3. 点击"删除"
4. 该设备将无法再同步

---

## ⚠️ 重要提示

### 密码管理

1. **PIN码**: 用于本地解锁
2. **同步密码**: 用于多设备同步

建议：
- ✅ 使用强密码
- ✅ 两个密码不相同
- ✅ 妥善保管密码
- ❌ 忘记密码将无法恢复数据

### 数据安全

- 定期同步，避免数据丢失
- 不要在公共设备上启用自动同步
- 及时删除不再使用的设备

### 网络要求

- 需要网络连接才能同步
- 建议在WiFi下同步大量数据
- 移动网络也支持，但会消耗流量

---

## 🛠️ 故障排查

### 同步失败

**问题**: 同步一直失败
**解决**:
1. 检查网络连接
2. 确认同步密码正确
3. 查看错误日志
4. 尝试重新登录

### 冲突过多

**问题**: 频繁出现冲突
**解决**:
1. 在一个设备上完成编辑后再切换
2. 编辑完立即同步
3. 减少多设备同时编辑

### 数据不一致

**问题**: 不同设备数据不同
**解决**:
1. 手动触发同步
2. 检查最后同步时间
3. 重新登录云同步

---

## 📊 技术细节

### API端点

```
POST /api/sync/setup        # 首次设置
POST /api/sync/login        # 新设备登录
POST /api/sync/upload       # 上传数据
GET  /api/sync/download     # 下载数据
GET  /api/sync/changes      # 获取变更
GET  /api/devices           # 设备列表
DELETE /api/devices         # 删除设备
```

### 数据库表

- `users` - 用户信息
- `devices` - 设备列表
- `sync_entries` - 同步的日记
- `sync_history` - 同步历史

### 加密算法

- **对称加密**: AES-GCM-256
- **密钥派生**: PBKDF2 (150,000次迭代)
- **哈希**: SHA-256

---

## 🎯 最佳实践

1. **定期同步**: 每天至少同步一次
2. **多设备编辑**: 尽量避免同时编辑同一条日记
3. **及时更新**: 编辑后立即同步
4. **备份密码**: 将同步密码保存在安全的地方
5. **清理设备**: 不再使用的设备及时删除

---

## 📞 需要帮助？

如有问题，请：
1. 查看本文档的故障排查部分
2. 检查浏览器控制台的错误日志
3. 提交issue到GitHub仓库

---

## 🎉 开始使用

现在就开始使用云同步功能，让您的日记在所有设备上保持同步！

1. 进入"设置"
2. 开启"云同步"
3. 享受多设备同步的便利
